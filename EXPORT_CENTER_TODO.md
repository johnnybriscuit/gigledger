# Export Center - Remaining Tasks

## âœ… Completed (Phase 1)

### Database Layer
- âœ… Created SQL views for export data (`v_gigs_export`, `v_expenses_export`, `v_mileage_export`, `v_payers_export`)
- âœ… Created `calculate_schedule_c_summary()` function for tax calculations
- âœ… Created `get_tax_year_range()` helper function
- âœ… All views respect RLS (security_invoker = on)

### Application Layer
- âœ… Created Schedule C category mapper (`src/lib/scheduleCMapper.ts`)
  - Maps expense categories to IRS Schedule C line items
  - Handles 50% meals deduction
  - Configurable IRS mileage rates by year
- âœ… Created export hooks (`src/hooks/useExports.ts`)
  - `useGigsExport()`, `useExpensesExport()`, `useMileageExport()`, `usePayersExport()`
  - `useScheduleCSummary()` - aggregated tax data
  - `useAllExportData()` - fetches everything at once
- âœ… Created CSV export utilities (`src/lib/csvExport.ts`)
  - Individual CSV generators for each data type
  - CSV field escaping for special characters
  - Download functions with proper MIME types
- âœ… Created JSON backup export
  - Complete data backup in structured JSON format
  - Includes export metadata (date, version)

### UI
- âœ… Created ExportsScreen (`src/screens/ExportsScreen.tsx`)
  - Tax year selector (last 5 years)
  - Custom date range option
  - Include/exclude tips and fees toggles
  - Data summary cards (counts)
  - Export buttons with descriptions
  - Help section explaining what gets exported
- âœ… Added "Exports" tab to main navigation

## ðŸš§ TODO (Phase 2)

### Excel Export
**Priority: High**
- [ ] Install Excel library: `npm install xlsx`
- [ ] Create `src/lib/excelExport.ts`
- [ ] Implement `generateExcelWorkbook()` function
  - Create workbook with 5 sheets (Gigs, Expenses, Mileage, Payers, Schedule C)
  - Apply formatting (headers bold, currency formatting, date formatting)
  - Auto-size columns
  - Add summary sheet with totals
- [ ] Update ExportsScreen to enable Excel button
- [ ] Test with large datasets (5k+ rows)

**Implementation Notes:**
```typescript
import * as XLSX from 'xlsx';

export function generateExcelWorkbook(data) {
  const wb = XLSX.utils.book_new();
  
  // Add sheets
  const gigsSheet = XLSX.utils.json_to_sheet(data.gigs);
  XLSX.utils.book_append_sheet(wb, gigsSheet, 'Gigs');
  
  // ... add other sheets
  
  // Generate file
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  return new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
}
```

### PDF Tax Summary
**Priority: High**
- [ ] Choose PDF library (options below)
- [ ] Create `src/lib/pdfExport.ts`
- [ ] Implement PDF generator with sections:
  1. **Header**: User info, tax year, generation date
  2. **Income Summary**: Gross receipts, returns/allowances, net receipts
  3. **Expenses by Schedule C Line**: Table with line names and amounts
  4. **Mileage Summary**: Total miles, rate, deduction
  5. **Tax Estimates**:
     - Self-employment tax (15.3% of net profit)
     - Federal estimated tax (using existing withholding calculator)
     - State tax (from user profile)
  6. **Footer**: "Generated by GigLedger vX.Y" + timestamp
- [ ] Update ExportsScreen to enable PDF button
- [ ] Test PDF rendering on web and mobile

**PDF Library Options:**
1. **@react-pdf/renderer** (Recommended for React Native)
   - Pros: Works on mobile, React-like syntax
   - Cons: Limited styling options
   - Install: `npm install @react-pdf/renderer`

2. **pdfmake** (Web-focused)
   - Pros: Rich formatting, works in browser
   - Cons: May need polyfills for React Native
   - Install: `npm install pdfmake`

3. **Supabase Edge Function** (Server-side)
   - Pros: No client-side dependencies, consistent rendering
   - Cons: Requires edge function deployment
   - Use Deno + puppeteer or wkhtmltopdf

### Unit Tests
**Priority: Medium**
- [ ] Create `src/lib/__tests__/scheduleCMapper.test.ts`
  - Test category mapping
  - Test 50% meals deduction
  - Test mileage rate lookup by year
  - Test expense grouping
- [ ] Create `src/lib/__tests__/csvExport.test.ts`
  - Test CSV field escaping (commas, quotes, newlines)
  - Test empty data handling
  - Test large datasets
- [ ] Create `src/hooks/__tests__/useExports.test.ts`
  - Test date filtering
  - Test RLS (users only see their data)
  - Mock Supabase responses

**Test Framework Setup:**
```bash
npm install --save-dev jest @testing-library/react-native @testing-library/jest-native
```

### Supabase Edge Function (Optional)
**Priority: Low**
- [ ] Create `supabase/functions/export-tax-package/index.ts`
- [ ] Implement server-side export generation
  - Validate auth.uid
  - Fetch data with RLS
  - Generate CSVs + PDF
  - Upload to Storage bucket: `exports/<uid>/<timestamp>/`
  - Return pre-signed URLs (valid for 1 hour)
- [ ] Add "Email me" option in UI
  - Send email with download links
  - Use Supabase's built-in email or SendGrid
- [ ] Create export history table
  - Track when exports were generated
  - Allow re-downloading recent exports

**Edge Function Template:**
```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_ANON_KEY')!,
    { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
  );
  
  // Validate user
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return new Response('Unauthorized', { status: 401 });
  
  // Generate exports...
  
  return new Response(JSON.stringify({ urls }), {
    headers: { 'Content-Type': 'application/json' },
  });
});
```

## ðŸ“‹ Future Enhancements (Phase 3)

### TXF Generator for TurboTax
- [ ] Research TXF file format specification
- [ ] Create `src/lib/txfExport.ts`
- [ ] Map Schedule C lines to TXF codes
- [ ] Test import into TurboTax Desktop
- [ ] Document limitations (TXF is legacy format)

### QuickBooks CSV Template
- [ ] Research QuickBooks CSV import format
- [ ] Create `src/lib/quickbooksExport.ts`
- [ ] Map categories to QuickBooks accounts
- [ ] Provide import instructions for users

### Export History & Email
- [ ] Create `export_history` table
  ```sql
  CREATE TABLE export_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users NOT NULL,
    export_type TEXT NOT NULL, -- 'csv', 'excel', 'pdf', 'json'
    tax_year INTEGER NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    file_urls JSONB, -- Storage URLs
    created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```
- [ ] Add "Export History" section to ExportsScreen
- [ ] Implement "Email me" functionality
- [ ] Auto-delete old exports after 30 days

### Accrual Mode
- [ ] Add `accounting_method` to user profile ('cash' or 'accrual')
- [ ] For accrual mode:
  - Recognize income when invoiced (use `date` field)
  - Recognize expenses when incurred (use `date` field)
  - Track unpaid invoices separately
- [ ] Update tax calculations to respect accounting method
- [ ] Add toggle in ExportsScreen filters

## ðŸ§ª Testing Checklist

Before marking complete, test:
- [ ] Export with 0 records (empty CSVs should have headers)
- [ ] Export with 10,000+ records (performance test)
- [ ] CSV opens correctly in Excel/Google Sheets (UTF-8 encoding)
- [ ] Special characters in fields (commas, quotes, newlines)
- [ ] Date range filtering works correctly
- [ ] Tips/fees toggles affect totals correctly
- [ ] Schedule C totals match dashboard totals
- [ ] Meals are 50% in Schedule C summary
- [ ] Mileage deduction uses correct IRS rate
- [ ] RLS prevents users from seeing others' data
- [ ] PDF renders correctly on mobile and web
- [ ] Excel file opens without errors

## ðŸ“š Documentation Needed

- [ ] Add "Export Center" section to README.md
- [ ] Create EXPORT_GUIDE.md for users
  - How to use filters
  - What each CSV contains
  - How to send to CPA
  - Tax preparation tips
- [ ] Document Schedule C mapping in code comments
- [ ] Add JSDoc comments to all export functions
- [ ] Create video tutorial (optional)

## ðŸ”§ Known Issues

1. **TypeScript Errors**: Supabase types need regeneration after running migrations
   - Run: `npx supabase gen types typescript --project-id <project-id> > src/types/supabase.ts`

2. **RPC Function Permissions**: If `calculate_schedule_c_summary` fails:
   - Ensure function has `SECURITY DEFINER`
   - Grant execute to authenticated users
   - Check RLS policies on underlying tables

3. **Browser Download Limits**: Some browsers block multiple simultaneous downloads
   - CSV downloads use staggered timeouts (200ms between each)
   - Consider ZIP file option for all CSVs

## ðŸŽ¯ Acceptance Criteria

- [x] All exports respect RLS
- [x] CSVs open cleanly in Excel/Google Sheets
- [ ] PDF shows same totals as dashboard
- [x] Expenses correctly mapped to Schedule C categories
- [x] Meals are 50% in summary
- [ ] Large datasets (5-10k rows) export successfully
- [ ] Unit tests for mapper and date filtering
- [ ] Documentation for users

## ðŸ“¦ Dependencies to Install

```bash
# For Excel export
npm install xlsx

# For PDF export (choose one)
npm install @react-pdf/renderer
# OR
npm install pdfmake

# For testing
npm install --save-dev jest @testing-library/react-native @testing-library/jest-native
```

## ðŸš€ Deployment Steps

1. Run migration: `20250121_create_export_views.sql`
2. Verify views are created: `SELECT * FROM v_gigs_export LIMIT 1;`
3. Test RPC function: `SELECT * FROM calculate_schedule_c_summary('<user-id>', '2024-01-01', '2024-12-31', true, true);`
4. Deploy app with new ExportsScreen
5. Test CSV downloads in production
6. Monitor for errors in Supabase logs

## ðŸ’¡ Tips for Implementation

- **Start with Excel**: It's easier than PDF and provides immediate value
- **Use Web Workers**: For large datasets, generate CSVs/Excel in a worker thread
- **Compress Large Files**: Use JSZip to create a single ZIP file for all exports
- **Cache Export Data**: Store generated files in Supabase Storage for 24 hours
- **Add Progress Indicators**: Show progress bar for large exports
- **Implement Rate Limiting**: Prevent abuse (max 10 exports per hour)
